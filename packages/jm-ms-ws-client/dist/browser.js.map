{"version":3,"file":"browser.js","sources":["../lib/browser/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/browser/index.js"],"sourcesContent":["const { EventEmitter } = require('jm-event')\nconst error = require('jm-err')\n\nconst Err = error.Err\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nmodule.exports = class Adapter extends EventEmitter {\n  constructor (uri) {\n    super({ async: true })\n    const ws = new WebSocket(uri) // eslint-disable-line\n    this.ws = ws\n    ws.onmessage = event => {\n      this.emit('message', event.data)\n    }\n    ws.onopen = () => {\n      this.emit('open')\n    }\n    ws.onerror = event => {\n      this.emit('error', event)\n    }\n    ws.onclose = event => {\n      this.emit('close', event)\n    }\n  }\n\n  send () {\n    if (!this.ws) throw errNetwork\n    this.ws.send.apply(this.ws, arguments)\n  }\n\n  close () {\n    if (!this.ws) throw errNetwork\n    this.ws.close.apply(this.ws, arguments)\n  }\n}\n","const log = require('jm-logger')\nconst { utils } = require('jm-ms-core')\nconst error = require('jm-err')\nconst { WebSocket: WS } = require('jm-net')\nconst Session = require('jm-ms-session')\n\nclass ClientSession extends Session {\n  request (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.request(opts)\n  }\n\n  notify (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.notify(opts)\n  }\n\n  onRequest (opts) {\n    opts.session = this\n    opts.ips && opts.ips.length && (opts.ip = opts.ips[0])\n    opts.protocol = 'ws'\n    return super.onRequest(opts)\n  }\n\n  toJSON () {\n    const { prefix, uri, timeout, debug } = this\n    return { prefix, uri, timeout, debug }\n  }\n}\n\nmodule.exports = function (_Adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout, logger = log.logger, debug } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    const path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const session = new ClientSession({\n      debug,\n      logger,\n      timeout\n    })\n\n    Object.assign(session, {\n      uri,\n      prefix,\n\n      send: function () {\n        ws.send.apply(ws, arguments)\n      },\n\n      close: function () {\n        ws.close.apply(ws, arguments)\n      }\n    })\n\n    ws\n      .on('message', message => {\n        session.emit('message', message)\n      })\n      .on('open', () => {\n        session.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        session.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        session.reset()\n        session.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (session.emit('heartBeat')) return true\n        session.notify('/', 'get')\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return session.emit('heartDead')\n      })\n      .on('connect', () => {\n        session.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        session.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        session.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return session\n  }\n}\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('../mdl')\n\nmodule.exports = mdl(Adapter)\n"],"names":["EventEmitter","require$$0","Err","error","errNetwork","err","FA_NETWORK","uri","async","ws","WebSocket","onmessage","event","emit","data","onopen","onerror","onclose","send","apply","arguments","close","utils","WS","require$$1","ClientSession","opts","preRequest","prefix","session","ips","length","ip","protocol","timeout","debug","Session","_Adapter","logger","log","FA_PARAMS","path","getUriPath","Object","assign","Adapter","connect","on","message","info","e","reset","notify","client","fnclient","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}