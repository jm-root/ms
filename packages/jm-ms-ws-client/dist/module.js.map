{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const log = require('jm-logger')\nconst { utils } = require('jm-ms-core')\nconst error = require('jm-err')\nconst { WebSocket: WS } = require('jm-net')\nconst Session = require('jm-ms-session')\n\nclass ClientSession extends Session {\n\n  request (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.request(opts)\n  }\n\n  notify (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.notify(opts)\n  }\n\n  onRequest(opts){\n    opts.session = this\n    opts.ips && opts.ips.length && (opts.ip = opts.ips[0])\n    opts.protocol = 'ws'\n    return super.onRequest(opts)\n  }\n\n  toJSON(){\n    const {prefix, uri, timeout, debug} = this\n    return {prefix, uri, timeout, debug}\n  }\n}\n\nmodule.exports = function (_Adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout, logger=log.logger, debug } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    let path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const session = new ClientSession({\n      debug,\n      logger,\n      timeout\n    })\n\n    Object.assign(session, {\n      uri,\n      prefix,\n\n      send: function () {\n        ws.send.apply(ws, arguments)\n      },\n\n      close: function () {\n        ws.close.apply(ws, arguments)\n      }\n    })\n\n    ws\n      .on('message', message => {\n        session.emit('message', message)\n      })\n      .on('open', () => {\n        session.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        session.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        session.reset()\n        session.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (session.emit('heartBeat')) return true\n        session.notify('/', 'get')\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return session.emit('heartDead')\n      })\n      .on('connect', () => {\n        session.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        session.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        session.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return session\n  }\n}\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["utils","require$$0","WS","require$$1","WebSocket","ClientSession","opts","preRequest","apply","arguments","uri","prefix","session","ips","length","ip","protocol","timeout","debug","Session","_Adapter","logger","log","error","err","Err","FA_PARAMS","path","getUriPath","ws","Object","assign","Adapter","connect","send","close","on","message","emit","info","e","event","reset","notify","client","fnclient","$","name","app","clientModules","wss","unuse"],"mappings":"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"}