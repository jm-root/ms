{"version":3,"file":"index.js","sources":["../lib/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/index.js"],"sourcesContent":["const { EventEmitter } = require('jm-event')\nconst WebSocket = require('ws')\n\nmodule.exports = class Adapter extends EventEmitter {\n  constructor (uri) {\n    super({ async: true })\n    const ws = new WebSocket(uri)\n    this.ws = ws\n    ws.on('message', (data, flags) => {\n      this.emit('message', data)\n    })\n    ws.onopen = () => {\n      this.emit('open')\n    }\n    ws.onerror = event => {\n      this.emit('error', event)\n    }\n    ws.onclose = event => {\n      this.emit('close', event)\n    }\n  }\n\n  send () {\n    this.ws.send(...arguments)\n  }\n\n  close () {\n    if (!this.ws) return\n    this.ws.close(...arguments)\n  }\n}\n","const log = require('jm-logger')\nconst { utils } = require('jm-ms-core')\nconst error = require('jm-err')\nconst { WebSocket: WS } = require('jm-net')\nconst Session = require('jm-ms-session')\n\nclass ClientSession extends Session {\n  request (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.request(opts)\n  }\n\n  notify (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.uri = this.prefix + (opts.uri || '')\n    return super.notify(opts)\n  }\n\n  onRequest (opts) {\n    opts.session = this\n    opts.ips && opts.ips.length && (opts.ip = opts.ips[0])\n    opts.protocol = 'ws'\n    return super.onRequest(opts)\n  }\n\n  toJSON () {\n    const { prefix, uri, timeout, debug } = this\n    return { prefix, uri, timeout, debug }\n  }\n}\n\nmodule.exports = function (_Adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout, logger = log.logger, debug } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    const path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const session = new ClientSession({\n      debug,\n      logger,\n      timeout\n    })\n\n    Object.assign(session, {\n      uri,\n      prefix,\n\n      send: function () {\n        ws.send.apply(ws, arguments)\n      },\n\n      close: function () {\n        ws.close.apply(ws, arguments)\n      }\n    })\n\n    ws\n      .on('message', message => {\n        session.emit('message', message)\n      })\n      .on('open', () => {\n        session.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        session.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        session.reset()\n        session.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (session.emit('heartBeat')) return true\n        session.notify('/', 'get')\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return session.emit('heartDead')\n      })\n      .on('connect', () => {\n        session.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        session.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        session.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return session\n  }\n}\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('./mdl')\n\nmodule.exports = mdl(Adapter)\n"],"names":["EventEmitter","require$$0","uri","async","ws","WebSocket","on","data","flags","emit","onopen","onerror","event","onclose","send","arguments","close","utils","WS","require$$1","ClientSession","opts","preRequest","apply","prefix","session","ips","length","ip","protocol","timeout","debug","Session","_Adapter","logger","log","error","err","Err","FA_PARAMS","path","getUriPath","Object","assign","Adapter","connect","message","info","e","reset","notify","client","fnclient","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}