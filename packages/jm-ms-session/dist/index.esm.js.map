{"version":3,"file":"index.esm.js","sources":["../lib/index.js"],"sourcesContent":["const { EventEmitter } = require('jm-event')\nconst MS = require('jm-ms-core')\nconst { utils } = MS\nconst ms = new MS()\n\nconst { err, Err } = require('jm-err')\nconst log = require('jm-logger')\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\n\nmodule.exports = class extends EventEmitter {\n  constructor (opts = {}) {\n    super()\n\n    const { debug = false, timeout = Timeout, logger = log.logger, router = ms.router() } = opts\n\n    debug && (logger.level = 'debug')\n\n    Object.assign(this, {\n      debug,\n      timeout,\n      logger,\n      router\n    })\n\n    this.reset()\n\n    this.on('message', this.onMessage.bind(this))\n  }\n\n  reset () {\n    Object.assign(this, {\n      requestId: 0,\n      cbs: {},\n      timers: {}\n    })\n  }\n\n  nextRequestId () {\n    if (this.requestId >= MAXID) this.requestId = 0\n    return ++this.requestId\n  }\n\n  // send request to remote\n  request (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.id || (opts.id = this.nextRequestId())\n\n    const { cbs, timers, timeout: defaultTimeout } = this\n    const { id, timeout = defaultTimeout } = opts\n\n    const p = new Promise((resolve, reject) => {\n      cbs[id] = {\n        resolve,\n        reject\n      }\n\n      timers[id] = setTimeout(() => {\n        delete timers[id]\n        if (cbs[id]) {\n          delete cbs[id]\n          reject(err(Err.FA_TIMEOUT))\n        }\n      }, timeout)\n    })\n\n    this.send(JSON.stringify(opts))\n\n    return p\n  }\n\n  // send request to remote\n  notify (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    this.send(JSON.stringify(opts))\n  }\n\n  // received request from remote and send response to remote\n  async onRequest (opts) {\n    const { id } = opts\n    const { debug, logger } = this\n    let data = null\n    try {\n      data = await this.router.request(opts)\n      if (debug) {\n        logger.debug(`ok. request:\\n${JSON.stringify(opts, null, 2)}\\nresponse:\\n${JSON.stringify(data, null, 2)}`)\n      }\n    } catch (e) {\n      if (debug) {\n        logger.debug(`fail. request:\\n${JSON.stringify(opts, null, 2)}\\nresponse:\\n${JSON.stringify(e.data, null, 2)}`)\n      }\n      logger.error(e)\n      data = e.data\n      data || (data = Object.assign({ status: e.status || Err.FA_INTERNALERROR.err }, Err.FA_INTERNALERROR, { msg: e.message }))\n    }\n    if (id) {\n      this.send(JSON.stringify({\n        id, data: data || {}\n      }))\n    }\n  }\n\n  // received response from remote\n  onResponse (opts) {\n    const { id, data: doc } = opts\n    const p = this.cbs[id]\n    if (!p) return\n\n    delete this.cbs[id]\n\n    if(this.timers[id]){\n      clearTimeout(this.timers[id])\n      delete this.timers[id]\n    }\n\n    if (doc && doc.err) {\n      p.reject(err(doc))\n    } else {\n      p.resolve(doc)\n    }\n  }\n\n  onMessage (message) {\n    this.debug && (this.logger.debug(`message received: ${message}`))\n    let json = null\n    try {\n      json = JSON.parse(message)\n    } catch (err) {\n      return\n    }\n\n    const { id, uri } = json\n\n    // received request or notify\n    if (uri) {\n      return this.onRequest(json)\n    }\n\n    // received response\n    if (id) {\n      return this.onResponse(json)\n    }\n  }\n\n  send () {\n    throw new Error('method send not implemented.')\n  }\n}\n"],"names":["i","args","then","direct","EventEmitter","require$$0","utils","MS","ms","err","require$$1","Err","Timeout","MAXID","opts","debug","timeout","logger","log","router","level","Object","assign","reset","on","onMessage","bind","requestId","cbs","timers","preRequest","apply","arguments","id","nextRequestId","defaultTimeout","p","Promise","resolve","reject","setTimeout","FA_TIMEOUT","send","JSON","stringify","data","request","e","error","status","FA_INTERNALERROR","msg","message","doc","clearTimeout","json","parse","uri","onRequest","onResponse","Error"],"mappings":"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"}