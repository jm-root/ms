{"version":3,"file":"index.js","sources":["../lib/index.js"],"sourcesContent":["const { EventEmitter } = require('jm-event')\nconst MS = require('jm-ms-core')\nconst { utils } = MS\nconst ms = new MS()\n\nconst { err, Err } = require('jm-err')\nconst log = require('jm-logger')\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\n\nmodule.exports = class extends EventEmitter {\n  constructor (opts = {}) {\n    super()\n\n    const { debug = false, timeout = Timeout, logger = log.logger, router = ms.router() } = opts\n\n    debug && (logger.level = 'debug')\n\n    Object.assign(this, {\n      debug,\n      timeout,\n      logger,\n      router\n    })\n\n    this.reset()\n\n    this.on('message', this.onMessage.bind(this))\n  }\n\n  reset () {\n    Object.assign(this, {\n      requestId: 0,\n      cbs: {}\n    })\n  }\n\n  nextRequestId () {\n    if (this.requestId >= MAXID) this.requestId = 0\n    return ++this.requestId\n  }\n\n  // send request to remote\n  request (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    opts.id || (opts.id = this.nextRequestId())\n\n    const { cbs, timeout: defaultTimeout } = this\n    const { id, timeout = defaultTimeout } = opts\n\n    const p = new Promise((resolve, reject) => {\n      cbs[id] = {\n        resolve,\n        reject\n      }\n\n      setTimeout(() => {\n        if (cbs[id]) {\n          delete cbs[id]\n          reject(err(Err.FA_TIMEOUT))\n        }\n      }, timeout)\n    })\n\n    this.send(JSON.stringify(opts))\n\n    return p\n  }\n\n  // send request to remote\n  notify (opts) {\n    opts = utils.preRequest.apply(this, arguments)\n    this.send(JSON.stringify(opts))\n  }\n\n  // received request from remote and send response to remote\n  async onRequest (opts) {\n    const { id } = opts\n    const { debug, logger } = this\n    let data = null\n    try {\n      data = await this.router.request(opts)\n      if (debug) {\n        logger.debug(`ok. request:\\n${JSON.stringify(opts, null, 2)}\\nresponse:\\n${JSON.stringify(data, null, 2)}`)\n      }\n    } catch (e) {\n      if (debug) {\n        logger.debug(`fail. request:\\n${JSON.stringify(opts, null, 2)}\\nresponse:\\n${JSON.stringify(e.data, null, 2)}`)\n      }\n      logger.error(e)\n      data = e.data\n      data || (data = Object.assign({ status: e.status || Err.FA_INTERNALERROR.err }, Err.FA_INTERNALERROR, { msg: e.message }))\n    }\n    if (id) {\n      this.send(JSON.stringify({\n        id, data: data || {}\n      }))\n    }\n  }\n\n  // received response from remote\n  onResponse (opts) {\n    const { id, data: doc } = opts\n    const p = this.cbs[id]\n    if (!p) return\n\n    delete this.cbs[id]\n\n    if (doc && doc.err) {\n      p.reject(err(doc))\n    } else {\n      p.resolve(doc)\n    }\n  }\n\n  onMessage (message) {\n    this.debug && (this.logger.debug(`message received: ${message}`))\n    let json = null\n    try {\n      json = JSON.parse(message)\n    } catch (err) {\n      return\n    }\n\n    const { id, uri } = json\n\n    // received request or notify\n    if (uri) {\n      return this.onRequest(json)\n    }\n\n    // received response\n    if (id) {\n      return this.onResponse(json)\n    }\n  }\n\n  send () {\n    throw new Error('method send not implemented.')\n  }\n}\n"],"names":["f","i","then","EventEmitter","require$$0","utils","MS","ms","err","require$$1","Err","Timeout","MAXID","opts","debug","timeout","logger","log","router","level","Object","assign","reset","on","onMessage","bind","requestId","cbs","preRequest","apply","arguments","id","nextRequestId","defaultTimeout","p","Promise","resolve","reject","setTimeout","FA_TIMEOUT","send","JSON","stringify","data","request","e","error","status","FA_INTERNALERROR","msg","message","doc","json","parse","uri","onRequest","onResponse","Error"],"mappings":"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"}